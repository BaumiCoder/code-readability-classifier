version: '3.8'

services:
  nvidia-services:
    image: rc:5
    command: sleep infinity
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities:
                - gpu
                - utility # nvidia-smi
                - compute # CUDA
                - video   # NVDEC/NVENC/NVCUVID. For instance to use hardware acceleration

  nvidia-smi:
    extends:
      service: nvidia-services
    command: nvidia-smi

  cuda:
    extends:
      service: nvidia-services
    command: python src/readability_classifier/utils/cuda-checker.py

  env:
    extends:
      service: nvidia-services
    volumes:
      - ./scripts:/scripts
    env_file:
      - variables.env

  help:
    extends:
      service: env
    entrypoint: /scripts/help.sh

  encode:
    extends:
      service: env
    command: /bin/bash -c "/scripts/encode.sh"

  train:
    extends:
      service: env
    command: /bin/bash -c "/scripts/train.sh"
